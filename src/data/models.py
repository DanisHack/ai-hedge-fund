"""Pydantic models for market data and agent outputs."""
from __future__ import annotations

from datetime import date, datetime
from enum import Enum
from typing import Optional

from pydantic import BaseModel, Field


# ── Market Data Models ──────────────────────────────────────────────


class Price(BaseModel):
    """Single OHLCV bar from Polygon aggregates."""
    open: float
    high: float
    low: float
    close: float
    volume: float
    timestamp: datetime
    vwap: Optional[float] = None
    transactions: Optional[int] = None


class FinancialMetrics(BaseModel):
    """Key financial metrics from Polygon stock financials."""
    ticker: str
    period: str
    fiscal_period: str
    filing_date: Optional[date] = None
    revenue: Optional[float] = None
    net_income: Optional[float] = None
    earnings_per_share: Optional[float] = None
    total_assets: Optional[float] = None
    total_liabilities: Optional[float] = None
    shareholders_equity: Optional[float] = None
    operating_cash_flow: Optional[float] = None
    free_cash_flow: Optional[float] = None
    gross_profit_margin: Optional[float] = None
    net_profit_margin: Optional[float] = None
    return_on_equity: Optional[float] = None
    debt_to_equity: Optional[float] = None
    current_ratio: Optional[float] = None


class CompanyNews(BaseModel):
    """A single news article from Polygon."""
    title: str
    author: Optional[str] = None
    published_utc: datetime
    article_url: str
    description: Optional[str] = None
    tickers: list[str] = Field(default_factory=list)


class CompanyDetails(BaseModel):
    """Ticker details from Polygon reference endpoint."""
    ticker: str
    name: str
    market_cap: Optional[float] = None
    description: Optional[str] = None
    sic_code: Optional[str] = None
    sic_description: Optional[str] = None
    homepage_url: Optional[str] = None
    total_employees: Optional[int] = None
    list_date: Optional[str] = None
    share_class_shares_outstanding: Optional[float] = None
    weighted_shares_outstanding: Optional[float] = None


# ── Agent Output Models ─────────────────────────────────────────────


class SignalType(str, Enum):
    """Trading signal direction."""
    BULLISH = "bullish"
    BEARISH = "bearish"
    NEUTRAL = "neutral"


class AnalystSignal(BaseModel):
    """Signal generated by an analyst agent for a single ticker."""
    agent_id: str
    ticker: str
    signal: SignalType
    confidence: float = Field(ge=0, le=100, description="Confidence 0-100")
    reasoning: str


class LLMAnalysisResult(BaseModel):
    """Structured output from LLM-powered analyst reasoning."""
    signal: SignalType = Field(description="Trading signal: bullish, bearish, or neutral")
    confidence: float = Field(ge=0, le=100, description="Confidence level 0-100")
    reasoning: str = Field(description="2-4 sentence explanation citing specific data points")


class TradeAction(str, Enum):
    """Portfolio manager trade action."""
    BUY = "buy"
    SELL = "sell"
    HOLD = "hold"


class Position(BaseModel):
    """A single portfolio position decision."""
    ticker: str
    action: TradeAction
    quantity: int
    confidence: float = Field(ge=0, le=100)
    reasoning: str


class Portfolio(BaseModel):
    """Full portfolio output from the portfolio manager."""
    positions: list[Position] = Field(default_factory=list)
    cash_remaining: float = 0.0
    total_value: float = 0.0
